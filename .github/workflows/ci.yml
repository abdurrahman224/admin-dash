name: React CI/CD Pipeline on GitHub Actions

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  checks: write
  contents: read
  packages: write

env:
  IMAGE_TAG: 1.0.0
  APP_PORT: 8085
  APP_NAME: ${{ github.event.repository.name }}

# ---------------------------------------------------
# JOB 1 - SONARQUBE ANALYSIS
# ---------------------------------------------------
jobs:
  sonar:
    name: ðŸ”Ž SonarQube Analysis
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Run SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

# ---------------------------------------------------
# JOB 2 - BUILD REACT APP (NO TESTS)
# ---------------------------------------------------
  build:
    name: ðŸ§± Build React App
    runs-on: ubuntu-latest
    needs: sonar

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§± Build React app
        run: npm run build

# ---------------------------------------------------
# JOB 3 - DOCKER BUILD & PUSH
# ---------------------------------------------------
  publish:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”¤ Normalize repo name to lowercase
        run: echo "REPO_LOWERCASE=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: ðŸ³ Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: ðŸ› ï¸ Build Docker image
        run: docker build -t ghcr.io/$REPO_LOWERCASE:$IMAGE_TAG .

      - name: ðŸ“¤ Push Docker image
        run: docker push ghcr.io/$REPO_LOWERCASE:$IMAGE_TAG

# ---------------------------------------------------
# JOB 4 - MANUAL DEPLOY
# ---------------------------------------------------
  deploy:
    name: ðŸš€ Deploy to VPS (Manual Only)
    runs-on: ubuntu-latest
    needs: publish
    # if: github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ”¤ Normalize repo name to lowercase
        run: echo "REPO_LOWERCASE=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: ðŸ“¡ SSH Deploy to VPS
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          envs: REPO_LOWERCASE,IMAGE_TAG,APP_NAME,APP_PORT
          script: |
            echo "DÃ©ploiement React sur VPS..."

            sudo docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}

            FULL_IMAGE="ghcr.io/$REPO_LOWERCASE:$IMAGE_TAG"
            echo "Image : $FULL_IMAGE"

            sudo docker pull $FULL_IMAGE

            if sudo docker ps -a --format '{{.Names}}' | grep -q "^$APP_NAME$"; then
              sudo docker stop $APP_NAME || true
              sudo docker rm $APP_NAME || true
            fi

            sudo docker run -d --name $APP_NAME -p $APP_PORT:80 $FULL_IMAGE
            echo "ðŸš€ DÃ©ploiement terminÃ© avec succÃ¨s !"

